# PS1スタイルテクスチャジェネレーター 技術設計書

## 1. 概要

本設計書は、PS1スタイルテクスチャジェネレーターの技術的なアプローチと主要な設計決定事項を定義します。

### 主要な設計決定
- **Electron + React + TypeScript**：クロスプラットフォーム対応可能なデスクトップアプリケーション基盤
- **コンポーネントベースアーキテクチャ**：再利用性と保守性を重視したUI設計
- **Web Worker活用**：画像処理の非同期実行によるUIの応答性確保
- **Three.js統合**：リアルタイム3Dプレビューの実装
- **イベント駆動設計**：UIとビジネスロジックの疎結合化

## 2. アーキテクチャ

### システムレイヤー
1. **プレゼンテーション層**（React Components）
   - ユーザーインターフェースの管理
   - ユーザー入力の処理
   - ビューの状態管理

2. **アプリケーション層**（Services）
   - ビジネスロジックの実装
   - データフローの制御
   - 外部サービスとの連携

3. **ドメイン層**（Core Logic）
   - 画像処理アルゴリズム
   - データ変換ロジック
   - ビジネスルールの実装

4. **インフラストラクチャ層**（Electron APIs）
   - ファイルシステムアクセス
   - ネイティブダイアログ
   - システムリソース管理

### 技術スタック
- **フロントエンド**: React 18.x, TypeScript 5.x
- **3Dレンダリング**: Three.js
- **状態管理**: React Context API + useReducer
- **スタイリング**: CSS Modules
- **ビルドツール**: Vite
- **デスクトップ統合**: Electron 28.x
- **画像処理**: Canvas API, Web Workers
- **テスト**: Vitest, React Testing Library

## 3. ディレクトリ構造とコンポーネント

### コンポーネント設計原則

1. **純粋なプレゼンテーション層の維持**
   - UIコンポーネント（`/components`配下）は表示とユーザーインタラクションのみを担当
   - ビジネスロジック、API通信、データ変換処理は含めない
   - 外部からpropsで必要なデータと関数を受け取る

2. **ロジックの配置場所**
   - **サービス層（`/services`）**: API通信、ファイル操作、外部システム連携
   - **カスタムフック（`/hooks`）**: コンポーネントとサービス層の橋渡し、状態管理
   - **コアロジック（`/core`）**: 純粋な計算処理、アルゴリズム実装
   - **ユーティリティ（`/utils`）**: 汎用的なヘルパー関数、バリデーション

3. **コンポーネントの責務**
   - Props経由でのデータ受け取りと表示
   - ユーザーイベントの検知とコールバック呼び出し
   - ローカルなUI状態の管理（開閉状態、ホバー状態など）
   - スタイリングとアニメーション

```
src/
├── main/                    # Electronメインプロセス
│   ├── index.ts            # メインプロセスエントリーポイント
│   ├── menu.ts             # アプリケーションメニュー設定
│   └── dialogs/            # ネイティブダイアログ管理
│       ├── fileDialog.ts
│       └── saveDialog.ts
│
├── renderer/               # Electronレンダラープロセス
│   ├── index.tsx          # レンダラーエントリーポイント
│   ├── App.tsx            # ルートコンポーネント
│   │
│   ├── components/        # UIコンポーネント
│   │   ├── ImageInput/    # 画像入力コンポーネント
│   │   ├── ImagePreview/  # 2D画像プレビュー
│   │   ├── Preview3D/     # 3Dプレビューコンポーネント
│   │   ├── ParameterControls/ # パラメータ調整UI
│   │   └── SaveButton/    # 保存機能
│   │
│   ├── services/          # アプリケーションサービス
│   │   ├── imageProcessor.ts    # 画像処理サービス
│   │   ├── fileService.ts       # ファイル操作サービス
│   │   └── previewService.ts    # プレビュー管理サービス
│   │
│   ├── core/              # コアビジネスロジック
│   │   ├── pixelation/    # ピクセレート処理
│   │   ├── dithering/     # ディザリング処理
│   │   └── colorReduction/ # 色数削減処理
│   │
│   ├── workers/           # Web Workers
│   │   └── imageProcessing.worker.ts
│   │
│   ├── hooks/             # カスタムReactフック
│   │   ├── useImageProcessor.ts
│   │   └── useThreeScene.ts
│   │
│   ├── styles/            # グローバルスタイル
│   │   ├── globals.css    # グローバルCSS
│   │   ├── variables.css  # CSS変数定義
│   │   └── theme.ts       # テーマ定数
│   │
│   ├── types/             # TypeScript型定義
│   │   ├── image.ts
│   │   ├── processing.ts
│   │   └── ui.ts
│   │
│   └── utils/             # ユーティリティ関数
│       ├── validation.ts
│       └── helpers.ts
│
├── shared/                # メイン・レンダラー共通コード
│   └── constants.ts
│
└── assets/               # 静的リソース
    └── icons/
```

### 実装状況（2025-07-26 更新）

以下のディレクトリ構造とファイルは作成済み：
- **components/**: ImageInput, ImagePreview, Preview3D, ParameterControls, SaveButton（空のコンポーネント）
- **hooks/**: useImageProcessor, useThreeScene（空のhook）
- **services/**: imageProcessor, fileService, previewService（空のサービス）
- **types/**: image, processing, ui（基本的な型定義）
- **utils/**: validation, helpers（空のユーティリティ）
- 各ディレクトリにindex.tsファイルを配置し、named exportで各モジュールを公開

**注意**: 現在は構造のみ作成済みで、実際の機能実装はこれから行う。

### 必要なクラス/モジュール
- **ImageProcessor**: 画像処理の中核クラス
- **DragDropHandler**: ドラッグ&ドロップ処理
- **ThreeSceneManager**: 3Dシーン管理
- **ParameterStore**: パラメータ状態管理
- **FileHandler**: ファイル入出力処理

## 4. データモデル

### 主要な型定義（概念）
- **ImageData**: 元画像と処理後画像の情報
- **ProcessingParameters**: 解像度、色数、ディザリング設定
- **PreviewState**: 2D/3Dプレビューの表示状態
- **ApplicationState**: アプリケーション全体の状態

### データフロー
1. 画像入力 → バリデーション → ストレージ
2. パラメータ変更 → Web Worker実行
3. 処理結果 → プレビュー更新 → UI反映

## 5. 処理パイプライン

### 画像処理ワークフロー
1. **入力検証**
   - ファイル形式チェック
   - 画像サイズ検証
   - メモリ使用量推定

2. **前処理**
   - 画像のデコード
   - 作業用バッファの確保
   - アスペクト比計算

3. **変換処理**（Web Worker内）
   - リサイズ処理（長辺基準）
   - 色空間変換
   - ディザリング適用
   - 色数削減

4. **後処理**
   - 結果の検証
   - プレビュー用データ生成
   - メモリ解放

### 3Dプレビューパイプライン
1. Three.jsシーン初期化
2. ジオメトリ（立方体）生成
3. テクスチャ適用とマテリアル設定
4. カメラとコントロール設定
5. レンダリングループ管理

## 6. エラーハンドリング

### エラーカテゴリ
- **入力エラー**: 非対応ファイル形式、破損ファイル
- **処理エラー**: メモリ不足、処理タイムアウト
- **保存エラー**: ディスク容量不足、権限エラー
- **3Dエラー**: WebGLサポートなし、GPU制限

### エラー処理戦略
- ユーザーフレンドリーなエラーメッセージ表示
- 部分的な機能低下への対応（3D無効化など）
- エラーログの記録と分析
- 自動リトライメカニズム（一部の処理）

## 7. テスト戦略

### テスト駆動開発（TDD）アプローチ
1. **コアロジックのユニットテスト**
   - 画像処理アルゴリズムのテストを先に記述
   - エッジケースの定義と検証
   - パフォーマンス基準の設定

2. **コンポーネントテスト**
   - React Testing Libraryによるコンポーネント動作検証
   - ユーザーインタラクションのシミュレーション
   - 状態管理の整合性確認

3. **統合テスト**
   - Electron環境でのE2Eテスト
   - ファイル操作の実動作確認
   - クロスプロセス通信の検証

4. **パフォーマンステスト**
   - 各種サイズの画像処理時間測定
   - メモリ使用量の監視
   - UIの応答性確認

## 8. パフォーマンス考慮事項

### 最適化戦略
- **Web Worker活用**: CPU集約的な処理の分離によるUI応答性の確保
- **メモリ管理**: 処理完了後の画像バッファの適切な解放

## 9. UIデザインとスタイリング

### デザインコンセプト
- **レトロターミナル風**: 90年代のコンピューターターミナルを彷彿とさせるデザイン
- **モノトーンカラースキーム**: 黒系背景にグリーン系のアクセントカラー
- **固定テーマ**: ダークモード/ライトモードの切り替えなし

### カラーパレット
- **背景色**: 
  - メイン背景: #0a0a0a（ほぼ黒）
  - セカンダリ背景: #1a1a1a（ダークグレー）
  - パネル背景: #0f0f0f
- **テキスト色**:
  - プライマリテキスト: #00ff00（ライムグリーン）
  - セカンダリテキスト: #00cc00（ダークライムグリーン）
  - 非アクティブテキスト: #006600
- **アクセント色**:
  - ホバー/フォーカス: #00ff00（30% opacity）
  - ボーダー: #00ff00（50% opacity）
  - エラー: #ff0066

### タイポグラフィ
- **フォントファミリー**: 'Courier New', 'Consolas', monospace
- **フォントサイズ**:
  - 本文: 14px
  - ヘッダー: 18px
  - 小テキスト: 12px

### UIコンポーネントスタイル
- **ボタン**: フラットデザイン、グリーンボーダー、ホバー時に背景色変化
- **入力フィールド**: 黒背景、グリーンボーダー、グリーンテキスト
- **パネル**: わずかなボーダー、シャドウなし
- **スクロールバー**: カスタムスタイル（黒背景、グリーントラック）

### アニメーション
- **トランジション**: 150ms ease-in-out
- **ローディング**: 点滅するドット表示
- **ホバーエフェクト**: 微細なグロー効果